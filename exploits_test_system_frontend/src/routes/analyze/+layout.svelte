<script>
    import { invalidateAll, goto } from '$app/navigation';
    import DotPattern from "$lib/components/DotPattern.svelte";
    import Highlight, { LineNumbers } from "svelte-highlight";
    import typescript from "svelte-highlight/languages/typescript";
    import ashes from "svelte-highlight/styles/ashes";

    let { children, data } = $props();
    let vulnerabilities = data?.vulnerabilities;

    const severityStyles = {
        critical: { color: "bg-red-800", icon: "!!", label: "Critical" },
        high: { color: "bg-red-600", icon: "!", label: "High" },
        medium: { color: "bg-orange-400", icon: "!", label: "Medium" },
        low: { color: "bg-yellow-400", icon: "!", label: "Low" }
    };

    let isOpen = $state(false);

    function toggleMenu() {
        isOpen = !isOpen;
    }

    async function navigateAndInvalidate(url) {
        await goto(url, { replaceState: true, invalidateAll: true });
        window.location.reload(); // Forces the page to reload
    }
</script>

<svelte:head>
    {@html ashes}
</svelte:head>

<div class="relative h-screen w-screen overflow-scroll bg-gradient-to-b from-black to-[#060C06]">

    <DotPattern
        class="absolute inset-0 h-full w-full [mask-image:radial-gradient(800px_circle_at_center,white,transparent)]"
        fillColor="rgba(67,76,67,0.7)"
    />

    {@render children()}
    
    <div class="fixed inset-y-0 top-16 right-0 z-50 w-full lg:w-96 bg-[#121212] p-6 rounded-l-3xl shadow-lg max-h-[95vh] text-white transition-transform transform {isOpen ? 'translate-x-0' : 'translate-x-full'} lg:translate-x-0">
    
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold font-heading">Data at Risk <span class="text-sm text-gray-400">({vulnerabilities?.length})</span></h2>
            <button onclick={toggleMenu} class="block lg:hidden text-gray-400 hover:text-white">
                &times; <!-- Close button for mobile -->
            </button>
        </div>


        <div class="space-y-4 max-h-[95%] overflow-y-auto pr-2">
            {#each vulnerabilities as vulnerability, i}
            <div
                role="button"
                tabindex="0"
                onclick={() => navigateAndInvalidate(`/analyze?id=${vulnerability.id}`)}
                class="flex bg-[#1E1E1E] p-4 rounded-3xl shadow-md hover:shadow-lg hover:bg-[#2A2A2A] transition-all duration-200 cursor-pointer"
            >
                <!-- Left: Severity Circle -->
                <div class="flex flex-col items-center mr-4">
                    <div class="{severityStyles[vulnerability.severity].color} h-10 w-10 rounded-full flex items-center justify-center">
                        <div class="h-6 w-6 rounded-full bg-white flex items-center justify-center">
                            <span class="text-red-500 text-sm font-bold font-heading">{severityStyles[vulnerability.severity].icon}</span>
                        </div>
                    </div>
                    <p class="text-xs mt-2 text-gray-400">{severityStyles[vulnerability.severity].label}</p>
                </div>

          
                <div class="flex-1">
                    <p class="font-semibold text-white font-heading">{vulnerability.name}</p>
                    <p class="text-sm text-gray-400 font-body">{vulnerability.description}</p>
                </div>
            </div>
            {/each}
        </div>
    </div>


    {#if !isOpen}
    <button
        onclick={toggleMenu}
        class="fixed top-16 right-4 z-50 bg-[#1E1E1E] flex justify-center items-center h-10 w-10 p-3 rounded-full shadow-md text-white lg:hidden"
    >
        <span>&#9776;</span> <!-- Hamburger menu icon -->
    </button>
    {/if}
</div>
